<div class="publisher bt-1 border-light p-3 bg-white d-flex align-items-center">
  <img
    class="avatar avatar-xs"
    src="https://img.icons8.com/color/36/000000/administrator-male.png"
    alt="..."
  />
  <input
    class="publisher-input flex-grow-1"
    type="text"
    placeholder="Write something"
    id="messageInput"
  />
  <div class="d-flex">
    <input class="form-control" type="file" id="fileInput" />
    <button id="sendButton">Send</button>
  </div>
</div>

<script>
  // const chatId = "<%= chatId %>";
  const userId = "<%= user.id %>";
  const userName = "<%= user.name %>";

  let fileName = "";
  let fileBase64 = "";
  let fileType = "";

  const onFileInputChange = (e) => {
    // get a reference to the file
    const file = e.target.files[0];

    if (!file) {
      return;
    }

    fileName = file.name;
    fileType = file.type;

    // encode the file using the FileReader API
    const reader = new FileReader();
    reader.onloadend = () => {
      // use a regex to remove data url part
      const base64String = reader.result
        .replace("data:", "")
        .replace(/^.+,/, "");

      fileBase64 = base64String;
    };
    reader.readAsDataURL(file);
  };

  const reset = () => {
    $("#messageInput").val("");
    if (fileName) resetFileInput();
    fileBase64 = "";
    fileName = "";
    fileType = "";
  };

  const resetFileInput = () => {
    $("#fileInput").val("");
  };

  async function onSendMessage() {
    const messageText = $("#messageInput").val();

    if (!messageText && !fileName) {
      return;
    }

    const message = {
      senderId: userId,
      senderName: userName,
      text: messageText,
      file: fileName
        ? {
            name: fileName,
            type: fileType,
            data: fileBase64,
          }
        : null,
    };

    socket.emit("message:add", message, chatId);

    reset();
  }

  //////////
  (() => {
    $("#fileInput").on("change", function (e) {
      onFileInputChange(e);
    });

    $("#sendButton").on("click", function () {
      onSendMessage();
    });
  })();
</script>
