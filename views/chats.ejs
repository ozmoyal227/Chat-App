<style>
  .user-pic {
    width: 8vw;
  }

  /* .media-body > p:not(:last-child) {
    background: #fff;
    padding: 0.5rem;
    border-radius: 5px;
    margin-bottom: 0.5rem;
  } */
  .media.media-chat {
    /* min-width: 20%; */
  }
</style>

<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- User Panel -->
    <div class="col-md-3 bg-info">
      <div class="card-box text-center">
        <section>
          <div class="user-pic mx-auto my-4">
            <img
              src="/images/user.svg"
              class="img-fluid bg-secondary rounded-circle"
              alt="User Pic"
            />
          </div>
          <h4 class="m-0"><% if (locals.user) { %> <%= user.name %> <% } %></h4>
        </section>
        <hr class="m-4" />
        <section>Bottom</section>
      </div>
    </div>

    <!-- Chat -->
    <div class="p-0 col-md-9 bg-danger h-100">
      <div class="d-flex flex-column h-100">
        <!-- Messages -->
        <div
          id="chat-content"
          class="overflow-auto d-flex flex-column flex-grow-1 p-3"
        >
          <!-- Others message -->
          <% for (var i = 0; i < lobby.messages?.length ?? 0; i++) { %>

          <!-- Date -->
          <% if (!lobby.messages[i-1] ||
          !moment(lobby.messages[i].sentAt).isSame(lobby.messages[i-1].sentAt,
          'day')) { %>
          <div
            class="
              media media-meta-day
              text-center
              border-bottom border-top
              my-3
            "
          >
            <%= moment(lobby.messages[i].sentAt).format("MMM D") %> - <%=
            moment(lobby.messages[i].sentAt).fromNow() %>
          </div>
          <% } %> <% if (lobby.messages[i].senderId !== user.id) { %>
          <div
            class="
              media media-chat
              d-flex
              media-chat-reverse
              text-end
              flex-row-reverse
              align-self-end
              mb-2
            "
          >
            <% } else { %>
            <div class="media media-chat d-flex align-self-start mb-3">
              <% } %>

              <img
                class="avatar align-self-start"
                src="https://img.icons8.com/color/36/000000/administrator-male.png"
                alt="..."
              />
              <div class="card p-2 media-body flex-grow-1">
                <p class="mb-0">
                  <strong><%= lobby.messages[i].senderName %></strong>
                </p>
                <p class="mb-0"><%= lobby.messages[i].text %></p>
                <% if (lobby.messages[i].file?.name){ %>
                <p class="mb-0 bg-warning">
                  <%= lobby.messages[i].file.name %>
                </p>
                <% } %>

                <!-- Image Preview -->
                <% if (lobby.messages[i].file?.type &&
                isSupportedPreviewType(lobby.messages[i].file.type)){ %>
                <div>
                  <img
                    src="data:<%= lobby.messages[i].file.type %>;base64, <%= lobby.messages[i].file.data %>"
                  />
                </div>
                <% } %>

                <p class="meta m-0">
                  <span
                    ><%= moment(lobby.messages[i].sentAt).format("hh:mm A")
                    %></span
                  >
                </p>
              </div>
            </div>

            <% } %>
          </div>

          <!-- Add Message -->
          <%- include('./partials/add-message.ejs', { user:user, chatId:
          lobby.id}) %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const chatId = "<%= lobby?.id %>";

  const onConnect = () => {
    console.log("User connected...");
    socket.emit("chat:join", chatId);
  };

  const onNewMessageReceived = (message) => {
    console.log(message);
    // Add message to UI #chat-content
    const newMessage = createNewMessage(
      message.senderName,
      message.text,
      message.sentAt,
      message.file
    );
    $("#chat-content").append(newMessage);
    // scroll to bottom of chat-content
    $("#chat-content").animate(
      { scrollTop: $("#chat-content").prop("scrollHeight") },
      500
    );
  };

  const createNewMessage = (senderName, text, sentAt, file) => `
  <div class="media media-chat d-flex align-self-start mb-3">
    <img class="avatar align-self-start" src="https://img.icons8.com/color/36/000000/administrator-male.png" alt="...">
    <div class="card p-2 media-body flex-grow-1">
      <p class="mb-0">
        <strong>${senderName}</strong>
      </p>
      <p class="mb-0">${text}</p>
      ${
        file?.name
          ? `<p class="mb-0 bg-warning">
              ${file?.name}
            </p>`
          : ""
      }
      ${
        file?.type && isSupportedPreviewType(file.type)
          ? `<div>
            <img src="data:${file.type};base64, ${file.data}" />
          </div>`
          : ""
      }
      <p class="meta m-0">
        <span>${moment(sentAt).format("hh:mm A")}</span>
      </p>
    </div>
  </div>
  `;

  const isSupportedPreviewType = (type) => {
    const supportedTypes = [
      "image/png",
      "image/jpeg",
      "image/jpg",
      "image/svg+xml",
    ];
    return !!supportedTypes.find((t) => type === t);
  };

  socket.on("connect", onConnect);
  socket.on("message:add", (message) => {
    onNewMessageReceived(message);
  });
</script>
