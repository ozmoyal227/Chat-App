<style>
  .user-pic {
    width: 8vw;
  }

  #chat-content {
    background-image: url(https://i.pinimg.com/originals/1d/78/a2/1d78a25fb160b91a6ed46e7b44fcd096.jpg);
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
  } 

  #user-panel { 
    background-image: url(https://i.pinimg.com/originals/8e/86/e0/8e86e00ea4937313e4b90cbe9f25c281.jpg);
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
    /* filter: blur(8px);
    -webkit-filter: blur(8px); */
  }

  #fileInput {
    /* display: none; */
  }
 
</style>

<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- User Panel -->
    <div class="col-md-3" id="user-panel" >
      <div class="card-box text-center px-2">
        <section>
          <div class="user-pic mx-auto my-4">
            <img
              src="/images/user.svg"
              class="img-fluid bg-secondary rounded-circle"
              alt="User Pic"
            />
          </div>
          <h2 class="m-0"><% if (locals.user) { %> <%= user.name %> <% } %></h2>
        </section>
          <hr class="my-4 text-white" />
        <section>
          <!-- Files -->
          <h5 class="text-start text-white">My Files:</h5>
          <ul class="list-group" title="my files">
            <% for (var i = 0; i < user?.files?.length ?? 0; i++) { %>
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              <%= user.files[i].name %>
              <a
                class="btn btn-outline-primary"
                download="<%= user.files[i].name %>"
                href="data:<%= user.files[i].type %>;base64, <%= user.files[i].data %>"
              >
                <i class="bi bi-file-earmark-arrow-down"></i>
              </a>
            </li>
            <% } %>
          </ul>
        </section>
      </div>
    </div>

    <!-- Chat -->
    <div class="p-0 col-md-9 h-100" >
      <div class="d-flex flex-column h-100">
        <!-- Messages -->
        <div
          id="chat-content"
          class="overflow-auto d-flex flex-column flex-grow-1 p-3"
        >
          <!-- Others message -->
          <% for (var i = 0; i < lobby.messages?.length ?? 0; i++) { %>

          <!-- Date -->
          <% if (!lobby.messages[i-1] ||
          !moment(lobby.messages[i].sentAt).isSame(lobby.messages[i-1].sentAt,
          'day')) { %>
          <div
            class="media media-meta-day text-center border-bottom border-top my-3"
          >
            <%= moment(lobby.messages[i].sentAt).format("MMM D") %> - <%=
            moment(lobby.messages[i].sentAt).fromNow() %>
          </div>
          <% } %> <% if (lobby.messages[i].senderId !== user.id) { %>
          <div
            class="media media-chat d-flex media-chat-reverse text-end flex-row-reverse align-self-end mb-2"
          >
            <% } else { %>
            <div class="media media-chat d-flex align-self-start mb-3">
              <% } %>

              <img
                class="avatar align-self-start"
                src="https://img.icons8.com/color/36/000000/administrator-male.png"
                alt="..."
              />
              <div class="card p-2 media-body flex-grow-1">
                <p class="mb-0">
                  <strong><%= lobby.messages[i].senderName %></strong>
                </p>
                <p class="mb-0"><%= lobby.messages[i].text %></p>

                <% if (lobby.messages[i].file?.name){ %>
                <div class="file card">
                  <!-- Image Preview -->
                  <% if (lobby.messages[i].file?.type &&
                  isSupportedPreviewType(lobby.messages[i].file.type)){ %>
                  <img
                    class="img-fluid p-2"
                    src="data:<%= lobby.messages[i].file.type %>;base64, <%= lobby.messages[i].file.data %>"
                  />
                  <% } %>
                  <div class="card-body text-center">
                    <h5 class="card-title">
                      <%= lobby.messages[i].file.name %>
                    </h5>
                    <a
                      class="btn btn-outline-primary"
                      download="<%= lobby.messages[i].file.name %>"
                      href="data:<%= lobby.messages[i].file.type %>;base64, <%= lobby.messages[i].file.data %>"
                      ><i class="bi bi-file-earmark-arrow-down"></i
                    ></a>

                    <button
                      id="addFileToUserBtn"
                      class="btn btn-primary"
                      onclick="onAddFileToUser('<%= JSON.stringify(lobby.messages[i].file) %>' )"
                    >
                      <i class="bi bi-file-earmark-plus"></i>
                    </button>
                  </div>
                </div>

                <% } %>

                <p class="meta m-0">
                  <span
                    ><%= moment(lobby.messages[i].sentAt).format("hh:mm A")
                    %></span
                  >
                </p>
              </div>
            </div>

            <% } %>
          </div>

          <!-- Add Message -->
          <%- include('./partials/add-message.ejs', { user:user, chatId:
          lobby.id}) %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const chatId = "<%= lobby?.id %>";
  const userId = "<%= user?.id %>";

  const onConnect = () => {
    console.log("User connected...");
    socket.emit("chat:join", chatId);
  };

  const onNewMessageReceived = (message) => {
    console.log(message);
    // Add message to UI #chat-content
    const newMessage = createNewMessage(
      message.senderId,
      message.senderName,
      message.text,
      message.sentAt,
      message.file
    );
    $("#chat-content").append(newMessage);
    // scroll to bottom of chat-content
    $("#chat-content").animate(
      { scrollTop: $("#chat-content").prop("scrollHeight") },
      500
    );
  };

  const createNewMessage = (senderId, senderName, text, sentAt, file) => {
    return `
        <div class="media media-chat d-flex ${
          senderId === userId ? "align-self-start" : "align-self-end"
        } mb-3">
          <img class="avatar align-self-start" src="https://img.icons8.com/color/36/000000/administrator-male.png" alt="...">
          <div class="card p-2 media-body flex-grow-1">
            <p class="mb-0">
              <strong>${senderName}</strong>
            </p>
            <p class="mb-0">${text}</p>

            ${
              !file?.name
                ? ""
                : `<div class="file card">
                      ${
                        file?.type && isSupportedPreviewType(file.type)
                          ? `<img class="img-fluid p-2" src="data:${file.type};base64, ${file.data}" />`
                          : ""
                      }
                      <div class="card-body text-center">
                        <h5 class="card-title">${file.name}</h5>
                        <a class="btn btn-outline-primary" download="${
                          file.name
                        }" href="data:${file.type};base64, ${
                    file.data
                  }"><i class="bi bi-file-earmark-arrow-down"></i>
                        </a>

                        <button
                          class="btn btn-primary"
                          onclick='onAddFileToUser(${JSON.stringify(
                            JSON.stringify(file)
                          )})'
                        >
                          <i class="bi bi-file-earmark-plus"></i>
                        </button>
                      </div>
                  </div>`
            }


            <p class="meta m-0">
              <span>${moment(sentAt).format("hh:mm A")}</span>
            </p>
          </div>
        </div>
        `;
  };

  const isSupportedPreviewType = (type) => {
    const supportedTypes = [
      "image/png",
      "image/jpeg",
      "image/jpg",
      "image/svg+xml",
    ];
    return !!supportedTypes.find((t) => type === t);
  };

  socket.on("connect", onConnect);
  socket.on("message:add", (message) => {
    onNewMessageReceived(message);
  });

  const onAddFileToUser = async (file) => {
    const resp = await request("POST", "/users/files", JSON.parse(file));

    if (!resp || !resp.ok) {
      alert("Error adding file to user");
      return;
    }
  };
</script>
